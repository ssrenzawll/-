import { useState, useEffect, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";

export default function StarCatcherGame() {
  const GROUND_Y = 78; // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏∑‡πâ‡∏ô (‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡∏ö‡∏ô)

  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(30);
  const [starPos, setStarPos] = useState({ x: 50, y: 20 });
  const [kidPos, setKidPos] = useState({ x: 50, y: GROUND_Y });
  const [playing, setPlaying] = useState(false);
  const [gameStarted, setGameStarted] = useState(false);
  const [gameOver, setGameOver] = useState(false);
  const [sparkle, setSparkle] = useState(false);
  const audioRef = useRef(null);

  // ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
  useEffect(() => {
    if (!playing) return;
    if (timeLeft <= 0) return;

    const timer = setInterval(() => setTimeLeft((t) => t - 1), 1000);
    return () => clearInterval(timer);
  }, [playing, timeLeft]);

  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ timeLeft ‡∏ñ‡∏∂‡∏á 0 ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô gameOver
  useEffect(() => {
    if (timeLeft === 0 && playing) {
      setPlaying(false);
      setGameOver(true);
    }
  }, [timeLeft, playing]);

  // ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° (autoplay policy)
  useEffect(() => {
    if (audioRef.current) {
      // pause by default ‚Äî will be played when startGame() ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
      audioRef.current.pause();
      audioRef.current.currentTime = 0;
    }
  }, []);

  const moveStar = () => {
    const x = Math.random() * 85 + 5;
    const y = Math.random() * 50 + 5;
    setStarPos({ x, y });
  };

  const catchStar = () => {
    // ‡πÄ‡∏î‡πá‡∏Å‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡∏≤‡∏ß (‡πÉ‡∏ä‡πâ top/left ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡∏≤‡∏ß)
    setKidPos({ x: starPos.x, y: starPos.y });

    setTimeout(() => {
      setScore((s) => s + 1);
      setSparkle(true);
      moveStar();
      // ‡πÄ‡∏î‡πá‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏∑‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏ö
      setKidPos({ x: 50, y: GROUND_Y });
      setTimeout(() => setSparkle(false), 400);
    }, 350);
  };

  const startGame = () => {
    setScore(0);
    setTimeLeft(30);
    setPlaying(true);
    setGameStarted(true);
    setGameOver(false);
    moveStar();
    setKidPos({ x: 50, y: GROUND_Y });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏° autoplay policy)
    if (audioRef.current) {
      const p = audioRef.current.play();
      if (p && p.catch) p.catch(() => {});
    }
  };

  const restartGame = () => {
    // ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ End Screen
    setScore(0);
    setTimeLeft(30);
    setPlaying(true);
    setGameStarted(true);
    setGameOver(false);
    moveStar();
    setKidPos({ x: 50, y: GROUND_Y });

    if (audioRef.current) {
      const p = audioRef.current.play();
      if (p && p.catch) p.catch(() => {});
    }
  };

  const goToStartScreen = () => {
    // ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á)
    setPlaying(false);
    setGameStarted(false);
    setGameOver(false);
    setTimeLeft(30);
    setScore(0);
    if (audioRef.current) audioRef.current.pause();
  };

  // ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
  if (!gameStarted && !gameOver) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-white">
        <motion.h1 className="text-4xl font-extrabold mb-8 text-black">‚≠ê ‡πÄ‡∏Å‡∏°‡πÄ‡∏î‡πá‡∏Å‡∏à‡∏±‡∏ö‡∏î‡∏≤‡∏ß ‚≠ê</motion.h1>
        <motion.button
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.98 }}
          onClick={startGame}
          className="px-8 py-4 bg-yellow-400 text-purple-900 font-bold rounded-full shadow-lg"
        >‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</motion.button>
      </div>
    );
  }

  // ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏° (‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô)
  if (gameStarted && !gameOver) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-white relative">
        <audio ref={audioRef} loop src="/petal_rain.mp3" />

        <motion.h1 className="text-4xl font-extrabold mb-4 text-black drop-shadow">‚≠ê ‡πÄ‡∏Å‡∏°‡πÄ‡∏î‡πá‡∏Å‡∏à‡∏±‡∏ö‡∏î‡∏≤‡∏ß ‚≠ê</motion.h1>

        <div className="relative w-80 h-96 border-4 border-black rounded-2xl overflow-hidden bg-gray-100">
          {playing && timeLeft > 0 && (
            <div
              onClick={catchStar}
              className="absolute text-3xl cursor-pointer select-none hover:scale-125 transition"
              style={{ left: `${starPos.x}%`, top: `${starPos.y}%` }}
            >‚≠ê</div>
          )}

          <AnimatePresence>
            {sparkle && (
              <motion.div
                initial={{ scale: 0 }}
                animate={{ scale: 1.6 }}
                exit={{ opacity: 0 }}
                className="absolute text-4xl"
                style={{ left: `${starPos.x}%`, top: `${starPos.y}%` }}
              >‚ú®</motion.div>
            )}
          </AnimatePresence>

          {playing && (
            <motion.div
              animate={{ left: `${kidPos.x}%`, top: `${kidPos.y}%` }}
              transition={{ duration: 0.45 }}
              className="absolute text-4xl drop-shadow"
            >üßí</motion.div>
          )}

          {/* ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô/‡∏Å‡∏£‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ */}
        </div>

        {playing && (
          <div className="mt-4 flex gap-8 text-lg font-semibold border-2 border-black rounded-xl px-4 py-2 bg-gray-200">
            <p>‚è± {timeLeft} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
            <p>üéØ {score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
          </div>
        )}
      </div>
    );
  }

  // ‡∏´‡∏ô‡πâ‡∏≤ End Screen (‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°)
  if (gameOver) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-white">
        <div className="w-full max-w-md p-6 rounded-2xl shadow-lg text-center">
          <h1 className="text-3xl font-bold mb-6">‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!</h1>
          <p className="text-2xl mb-8">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: {score}</p>
          <div className="flex flex-col gap-4">
            <button
              onClick={restartGame}
              className="px-6 py-3 bg-blue-500 text-white rounded-xl text-lg"
            >
              ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            </button>
            <button
              onClick={goToStartScreen}
              className="px-6 py-3 bg-gray-300 text-black rounded-xl text-lg"
            >
              ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
            </button>
          </div>
        </div>
      </div>
    );
  }

  // ‡∏Ñ‡πà‡∏≤ fallback (‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ)
  return null;
}
